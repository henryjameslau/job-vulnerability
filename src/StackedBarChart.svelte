<svelte:options accessors={true}/>

<script>
  import { LayerCake, Html, Svg, flatten } from 'layercake';
  import { stack } from 'd3-shape';
  import { scaleBand, scaleOrdinal } from 'd3-scale';
  import { format, precisionFixed } from 'd3-format';

  import BarStacked from './components/BarStacked.svelte';
  import AxisX from './components/AxisX.svelte';
  import AxisY from './components/AxisY.svelte';
  import ChartLegend from './components/ChartLegend.svelte'
  import AxisYLabels from './components/AxisYLabelsHTML.svelte'


  // This example loads csv data as json using @rollup/plugin-dsv
  export let data = []
  export let yAxisLabel = ''
  export let padding = { top: 0, bottom: 20, left: 150 }
  export let dyTick = 28;

  const xKey = [0, 1];
  const yKey = 'year';
  const zKey = 'key';
  const yDomain = data.map(function(d){return d[yKey]}).reverse()

  const seriesNames = Object.keys(data[0]).filter(d => d !== yKey);
  export let seriesColours = ['#d0021b', '#EB7002', '#118C7B'];

  data.forEach(d => {
    seriesNames.forEach(name => {
      d[name] = +d[name];
    });
  });

  const stackData = stack()
    .keys(seriesNames);

  const series = stackData(data);

  const formatTickX = d => format(`.0f`)(d*100);

  //ie11 polyfill
  Number.isNaN = Number.isNaN || function isNaN(input) {
    return typeof input === 'number' && input !== input;
  }
</script>

<style>
  .chart-container {
    width: 100%;
    height: 100%;
    background-color:#fff;
  }
</style>

<div aria-hidden="true" class="chart-container">
  <LayerCake
    padding={padding}
    x={xKey}
    y={d => d.data[yKey]}
    z={zKey}
    yScale={scaleBand().paddingInner([0.1]).round(true)}
    yDomain={yDomain}
    zScale={scaleOrdinal()}
    zDomain={seriesNames}
    zRange={seriesColours}
    flatData={flatten(series)}
    data={series}
  >
    <Svg>
      <AxisX
        baseline={false}
        snapTicks={false}
        formatTick={formatTickX}
        label="%"
        gridlines={true}
        ticks={[0,0.25,0.5,0.75,1]}
      />
      <AxisY
        noticklabels={true}
        gridlines={false}
        label={yAxisLabel}
        dyTick={dyTick}
      />
      <BarStacked/>
    </Svg>

    <Html>
      <AxisYLabels/>
    </Html>
  </LayerCake>
</div>
