<svelte:options accessors={true}/>

<script>
	import { LayerCake, Svg, Html } from 'layercake';

	import Plot from './components/Bubble.svg.svelte';
	import AxisX from './components/AxisX.svelte';
	import AxisY from './components/AxisY.svelte';
	import QuadTree from './components/QuadTree.svelte';
	import AnnotationLines from './components/AnnotationLines.svelte';
	import ArrowheadDef from './components/ArrowheadDef.svelte';
	import AnnotationArrows from './components/AnnotationsArrows.svelte';
	import AnnotationLabels from './components/AnnotationsLabels.svelte';
	import AnnotationsCalloutCircle from './components/AnnotationsCalloutCircle.svelte';
	import ScatterLegend from './components/ScatterLegend.svelte';
	import { interpolate } from 'd3-interpolate';
	import { format } from 'd3-format';

  export let data
	export let index
	export let chartAnnotations

	let indexPrev=0

	import { tweened, spring } from "svelte/motion";

	const nocolour = data.map(({x,y,r,opacity}) => ({x,y,r,opacity}));
	const startColour = data.map(function(d){return d.fill})

	let dots = spring(
		nocolour,
		{
			stiffness: 0.1,
			damping: 0.9
		}
	);
	//

	let tweenedcolours = tweened(startColour, {
        duration: 500,
        interpolate: interpolate
    });

	const updateData = () => {
		const newDots = data.map(({x,y,r,opacity}) => ({x,y,r,opacity}));
    dots.set(newDots);
	};

	const updateColours = () => {
		const newColours = data.map(function(d){return d.fill})
		tweenedcolours.set(newColours)
	}


	//
	$: if(index!=indexPrev){
		updateData()
		updateColours()
		indexPrev=index
	}

	const staticAnnotations = [
		{
			 note:{
				 label: "Low pay (£9.12)",
				 wrap:200,
				 align:"left"
			 },
			 connector:{
			 },
			 x:-0.25,
			 y:9.12,
			 dx:-0.25,
			 dy:9.12
		 },{
			 note:{
				 label: "Higher earnings",
				 wrap:200,
				 align:"right"
			 },
			 connector:{
			 },
			 x:0.20,
			 y:50,
			 dx:+0.22,
			 dy:24
		 },{
			 note:{
				 label: "Earned more than last year",
				 wrap:150,
				 align:"left"
			 },
			 connector:{
			 },
			 x:0.02,
			 y:50,
			 dx:0.02,
			 dy:45
		 },{
			 note:{
				 label: "Earned less than last year",
				 wrap:150,
				 align:"right"
			 },
			 connector:{
			 },
			 x:-0.02,
			 y:50,
			 dx:-0.02,
			 dy:45
		 }
	]

	const staticArrows = [
		{
			 note:{
				 label: "Higher earnings",
				 wrap:200,
				 align:"right"
			 },
			 connector:{
			 },
			 x:0.24,
			 y:27.5,
			 dx:0.24,
			 dy:22
		 },{
			 note:{
				 label: "Earned more than last year",
				 wrap:150,
			 },
			 connector:{
			 },
			 x:0.08,
			 y:49,
			 dx:0.02,
			 dy:49
		 },{
			 note:{
				 label: "Earned less than last year",
				 wrap:150,
			 },
			 connector:{
			 },
			 x:-0.08,
			 y:49,
			 dx:-0.02,
			 dy:49
		 }
	]

	const annotationLines = [
	 {
		 x1:0,
		 x2:0,
		 y1:0,
		 y2:50,
	 },
	 {
		 x1:-0.25,
		 x2:0.25,
		 y1:0,
		 y2:0
	 },
	 {
		 x1:-0.25,
		 x2:0.25,
		 y1:9.12,
		 y2:9.12,
		 strokedasharray:"5 5"
	 }
 ];

 	const formatTickX = d => format('.0%')(d)
</script>



<div aria-hidden="true" class="chart-container">
	<LayerCake
		padding={{ top: 50, right: 10, bottom: 50, left: 25 }}
		x='x'
		y='y'
		r='r'
		xDomain={[-0.25,0.25]}
		yDomain={[0,50]}
		rDomain={[0,1005000]}
		data={$dots}
	>
		<Svg>
			<AxisX label="change pay from last year" formatTick={formatTickX} ticks=4/>
			<AxisY labelAnchor="start" label="Median hourly earnings (£)"/>
			<AnnotationLines {annotationLines}/>
			<ArrowheadDef fill='#707071'/>
			<AnnotationArrows hiddenOnMobile={true} stroke='#707071' arrowheads={true} chartAnnotations={staticArrows}/>
			<ScatterLegend/>
			<Plot colours={$tweenedcolours}/>
		</Svg>

		<Html>
				<AnnotationLabels hiddenOnMobile={true} chartAnnotations={staticAnnotations.slice(1)}/> 
				<AnnotationLabels chartAnnotations={[staticAnnotations[0]]}/>
		</Html>


		<Svg>
			<AnnotationsCalloutCircle {chartAnnotations}/>
		</Svg>

		<Html>
			<AnnotationLabels colour="{'#206095'}" {chartAnnotations}/>
		</Html>
	</LayerCake>
</div>


<style>
	.chart-container {
		width: 100%;
		height: 100%;
	}

	/* .circle {
    position: absolute;
		border:3px solid #212121;
    border-radius: 50%;
    background-color: #FFA500;
    transform: translate(-50%, -50%);
    pointer-events: none;
  }

	.tooltip{
		position: absolute;
		max-width:100px;
	} */
</style>
